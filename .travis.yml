# ----------------------------------------------------------------------------
#
# config
#
# ----------------------------------------------------------------------------

sudo: false
language: node_js

# we only care about the theme branch
branches:
    only:
        - landing

# notify srcc#github
notifications:
    slack:
        secure: ErfaD2eZV8I2ZYIascqS+41iOd44e6YLoIRCOXqruISLXYQqo1M8nJJvV6mYFKmQLE64RsBDrHkhZxaPM5h0uLj7kTNnb0Hk4Hb8xsEBOueB01gdoXUZHfxn/pVPrLjZLAvqHn8XxojEyzq0wVPlvBNcnJw3nATpsO3ZXjuOcdzKzzNsMqAwt/p5MmT7j7dBCOIs2J5EEmgDoxPyoejxyTn1SDOn3i9packcA+DWx3upIgePBhuaFJWEq8+9QyDPb5yMrjQQYH14shRVTh5bloHpN8OuuUfWIVo6vd6Odqysa076CPQ6858y2anH3H+C58lKgfaIO0K8cyBwO9W4eZPl3iJ2pUvMNGisedGz9Y6FX7kQ9J11vHquTTG60UT3JivOcMz7lBxWs4qVXaa40qmzpPKWwzGvfoW7uFjuGjJjkrNvFcLHHHOX7/jA9RfGZnk/iFjiAIYZ0XlqxsHJj0qgvm2/jKDr24ijFnE6/kz6OXMkrjK5Q2+FGDSLjq01B+KFLxvOgIj4apzvJtpIbYS9zRNmjjcHmz3YON3+PjqRFsip+/RDfATick274C0c5pyge8gE7rkZGGSvIYwjxeFYZaR5fH1teSBjA3utTVi8GtR1F5P58KPpmSoATMB7W3pTUcS7RCyGsbnws6ZhWmTPgjcMm6EkAXuVyqkpS2Y=


# ----------------------------------------------------------------------------
#
# build
#
# ----------------------------------------------------------------------------

# Node.js version
node_js: 5

# limit clone depth to 5, to speed up build
git:
    depth: 5

# cache dependencies
cache:
    directories:
        - node_modules

before_install:
    - |
      # check that we actually need to build anything
      if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
          TRAVIS_COMMIT_RANGE="FETCH_HEAD...$TRAVIS_BRANCH"
      fi
      git diff --name-only $TRAVIS_COMMIT_RANGE | grep -qvE '(\.md$)|(^(\.git|build))/' || {
          echo "Only non-source files were updated, no need to trigger a build."
          exit
      }

# install dependencies
install:
    - npm install

# build
script:
    - gulp build


# ----------------------------------------------------------------------------
#
# deployment
#
# ----------------------------------------------------------------------------

# deploy
#   fetch docs and copy contents of material/ there, then commit and push
after_success:
    - |
      # git config (global since we'll change repos to commit)
      git config --global user.email "travis@travis-ci.org"
      git config --global user.name  "Travis CI"
      git config --global push.default simple
      # fetch docs
      git clone https://${DEPLOY_KEY}@github.com/stanford-rc/www.sherlock.stanford.edu.git --branch docs --single-branch /tmp/docs/
      # copy output there
      rsync -avP build/ /tmp/docs/src/
      # commit+push changes
      cd /tmp/docs/
      git add -A src/
      git commit -m "Travis deploy from $TRAVIS_BRANCH to $(git rev-parse --abbrev-ref HEAD): ${TRAVIS_COMMIT:0:7}

      Travis build: $TRAVIS_BUILD_NUMBER"
      git push
